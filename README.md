# JWTTutorial

In this tutorial we will be learnig how to use JWT along with NodeJS + Express application.

### Step01-Create the project skelelton

- Create a folder for the project
- Create a src folder `mkdir src`
- Create the NodeJs project with: `npm init -y`
- Install the required packages
```
npm i nodemon express jsonwebtoken
```
- Create the minimal express server [src/app.js](./src/app.js)
```js
// Import the required modules
const express = require('express');

// Create the minimal express server
const app = express();

// Set route for the requests
app.use('/', (req, res, next) => {
    res.send(`Try not. Do, or do not. There is no try." - Yoda, The Empire Strikes Back`);
});

// Listen on port 3000
app.listen(3000, () => console.log('Server started on port 3000'));
```
- Start the server with `nodemon src/app.js`
- Open http://localhost:3000


### Step02-Add secured routes
- Create a "fake" user. In real life you will have a real user once the user has logged in 
```js
// Generate "fake" user for the tutorial
const user = {
    userId: 42,
    firstName: "Nir",
    lastName: "Geier",
    email: "nirgeier@gmail.com"
}
```

- Add route for simulate login `/login`

```js
// Set login route which will be protected 
// with JWT tokens
app.use('/login', (req, res, next) => {
    res.send(`Login ...`);
});
```
### Step03-Adding jwt and sign the user
- Import the jwt module
```js
jwt = require('jsonwebtoken')
```
- Set your secret string
```js
const SECRET = "try to guess ....";
```
- Use the `jwt.sign` inside the `/login` route
```js
// The sign method get the payload (data) and a secret key
// (Synchronous) Returns the JsonWebToken as string
// Set the token to expire in an hour from now
jwt.sign({
    exp: Math.floor(Date.now() / 1000) + (60 * 60),
    user: user
}, SECRET,
(err, token )=> {
    res.json(token);
}
);
```
- Verify that you get the token in your browser - navigate to : http://localhost:3000/login

### Step04-Securing the desired routes

In this tutorial we use the foloowing Authentication mechnism
#### Bearer Authentication
> - **Bearer authentication** (also called `token authentication`) is an HTTP authentication scheme that involves security tokens called bearer tokens. 
> - The name “Bearer authentication” can be understood as “give access to the bearer of this token.” 
> - The bearer token is a cryptic string, usually generated by the server in response to a login request. 
> - The client must send this token in the Authorization header when making requests to protected resources: **`Authorization: Bearer <token>`**
- Add function to extract the token
    ```js
    /**
     * Middleware for verifying the jwt token 
     * The token is in the following format:
     *    Authorization: Bearer <access_token>
     **/
    function extractToken(req, res, next) {
        // Get Authorization header which should be in the following format:
        const bearerHeader = req.headers['Authorization'];

        // Check if header was send in the request
        if (typeof bearerHeader !== 'undefined') {
            // Split the "Bearer <token>" value
            const tokens = bearerHeader.split(' ');
            // Save the token on the request 
            req.token = tokens[1];
            // Continue to the next Middleware
            next();
        } else {
            // Set unauthorized status code 
            // 403 Forbidden
            res.sendStatus(403);
        }
    }
    ```

- Add verification (validation) of the token
    ```js
    // Add a secured route
    // We are calling the extractToken
    app.get('/secure', extractToken, (req, res, next) => {

        // At this stage the token in on the request
        // Verify that the token is valid
        // verify a token symmetric
        jwt.verify(req.token, SECRET, (err, data) => {
            err ?
                res.send("Failed to verify token") :
                res.json(data);
        });
    });
    ```

### Step05-Test the code
- Test to verify that all is working.
- First we need to get the token: 
```sh 
curl localhost:3000/login
```
- Copy the generated token and paste it into the following command (replace the &lt;token):
```sh
curl \
    -H 'Accept: application/json' \
    -H "Authorization: Bearer <token>" \
    http://localhost:3000/secure
```